<!DOCTYPE html>
<html lang="en" class="grid">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>you've crossed an ocean and now you're here</title>
    <link rel="stylesheet" type="text/css" href="./styles_shared.css" />
    <link rel="stylesheet" type="text/css" href="./styles_website.css" />
    <script src="./gameplay.js" defer></script>
    <style>
      body {
        overflow: hidden;
      }

      .info {
        background-color: white;
        display: inline-block;
        font-size: 1.125rem;
        margin: 1px;
        padding: 10px;
        z-index: 2;
      }
    </style>
    <script>
      const COLORS = ["E6E6FA","D8BFD8","DDA0DD","EE82EE","DA70D6","FF00FF","BA55D3","9370DB","8A2BE2","9400D3","9932CC","8B008B","800080","4B0082","483D8B","6A5ACD","7B68EE","FFC0CB","FFB6C1","FF69B4","FF1493","DB7093","C71585","FFA07A","FA8072","E9967A","F08080","CD5C5C","DC143C","B22222","8B0000","FF0000","FF4500","FF6347","FF7F50","FF8C00","FFA500","FFFF00","FFFFE0","FFFACD","FAFAD2","FFEFD5","FFE4B5","FFDAB9","EEE8AA","F0E68C","BDB76B","FFD700","FFF8DC","FFEBCD","FFE4C4","FFDEAD","F5DEB3","DEB887","D2B48C","BC8F8F","F4A460","DAA520","B8860B","CD853F","D2691E","8B4513","A0522D","A52A2A","800000","556B2F","808000","6B8E23","9ACD32","32CD32","00FF00","7CFC00","7FFF00","ADFF2F","00FF7F","00FA9A","90EE90","98FB98","8FBC8F","3CB371","2E8B57","228B22","008000","006400","66CDAA","00FFFF","00FFFF","E0FFFF","AFEEEE","7FFFD4","40E0D0","48D1CC","00CED1","20B2AA","5F9EA0","008B8B","008080","B0C4DE","B0E0E6","ADD8E6","87CEEB","87CEFA","00BFFF","1E90FF","6495ED","4682B4","4169E1","0000FF","0000CD","00008B","000080","191970","FFFAFA","F0FFF0","F5FFFA","F0FFFF","F0F8FF","F8F8FF","F5F5F5","FFF5EE","F5F5DC","FDF5E6","FFFAF0","FFFFF0","FAEBD7","FAF0E6","FFF0F5","FFE4E1","DCDCDC","D3D3D3","C0C0C0","A9A9A9","808080","696969","778899","708090","2F4F4F"]
      const COLOR_NAMES = ["Lavender","Thistle","Plum","Violet","Orchid","Fuchsia","Magenta","MediumOrchid","MediumPurple","BlueViolet","DarkViolet","DarkOrchid","DarkMagenta","Purple","Indigo","DarkSlateBlue","SlateBlue","MediumSlateBlue","Pink","LightPink","HotPink","DeepPink","PaleVioletRed","MediumVioletRed","LightSalmon","Salmon","DarkSalmon","LightCoral","IndianRed","Crimson","FireBrick","DarkRed","Red","OrangeRed","Tomato","Coral","DarkOrange","Orange","Yellow","LightYellow","LemonChiffon","LightGoldenrodYellow","PapayaWhip","Moccasin","PeachPuff","PaleGoldenrod","Khaki","DarkKhaki","Gold","Cornsilk","BlanchedAlmond","Bisque","NavajoWhite","Wheat","BurlyWood","Tan","RosyBrown","SandyBrown","Goldenrod","DarkGoldenrod","Peru","Chocolate","SaddleBrown","Sienna","Brown","Maroon","DarkOliveGreen","Olive","OliveDrab","YellowGreen","LimeGreen","Lime","LawnGreen","Chartreuse","GreenYellow","SpringGreen","MediumSpringGreen","LightGreen","PaleGreen","DarkSeaGreen","MediumSeaGreen","SeaGreen","ForestGreen","Green","DarkGreen","MediumAquamarine","Aqua","Cyan","LightCyan","PaleTurquoise","Aquamarine","Turquoise","MediumTurquoise","DarkTurquoise","LightSeaGreen","CadetBlue","DarkCyan","Teal","LightSteelBlue","PowderBlue","LightBlue","SkyBlue","LightSkyBlue","DeepSkyBlue","DodgerBlue","CornflowerBlue","SteelBlue","RoyalBlue","Blue","MediumBlue","DarkBlue","Navy","MidnightBlue","White","Snow","Honeydew","MintCream","Azure","AliceBlue","GhostWhite","WhiteSmoke","Seashell","Beige","OldLace","FloralWhite","Ivory","AntiqueWhite","Linen","LavenderBlush","MistyRose","Gainsboro","LightGray","Silver","DarkGray","Gray","DimGray","LightSlateGray","SlateGray","DarkSlateGray","Black"]
      const CHOSEN_PALETTE = [ "darkgreen", "green", "forestgreen", "blue", "mediumblue", "royalblue", "gray", "darkgray", "silver", "lightgray", "dodgerblue", "deepskyblue", "darkviolet", "blueviolet", "darkorchid", "mediumpurple", "mediumorchid", "violet", "mediumslateblue", "slateblue", "darkslateblue", "deeppink", "hotpink", "palevioletred", "crimson", "orangered", "tomato", "orange", "darkorange", "gold", "darkkhaki", "rosybrown", "burlywood", "goldenrod", "chocolate", "saddlebrown", "sienna", "peru", "steelblue", "dimgray", "slategray", "darkslategray", "olivedrab", "darkolivegreen", "midnightblue", "mediumaquamarine", "limegreen", "yellowgreen", "salmon", "lightcoral", "indianred", "darksalmon", "thistle", "lavender", "plum", "pink", "orchid", "mediumseagreen", "brown", "lightsteelblue", "paleturquoise", "darkturquoise", "darkcyan", "turquoise", "springgreen"]
      const LANDSCAPE_KEY = 'landscape'

      const initialPositions = {
        "#you": [{ x: 2, y: 12 }],
        ".info": [
          { x: 2, y: 3, center: false },
          { x: 2, y: 5, center: false },
        ],
        ".cell": [],
      }

      const activeAreasToCreate = []

      const state = {
        boundaries: [], // there should be a boundary for the top and left of the page
        obstacles: [],
        activeArea: null,
        activeAreas: [],
        landscapeMap: {},
        newLandscapeMap: {}, // indexed by location, { position: {startX, startY}, color: ''}
        newLandscapeColor: '',
      }

      function toggleGrid() {
        const html = document.documentElement
        if (html && html.classList.contains("grid")) {
          html.classList.remove("grid")
        } else if (html) {
          html.classList.add("grid")
        }
      }

      function getRandomElement(list) {
        return list[Math.round(Math.random() * (list.length - 1))]
      }

      function setLandscapeColor() {
        state.newLandscapeColor = getRandomElement(CHOSEN_PALETTE)
      }

      function createIdFromPosition(pos) {
        const id = `${pos.startX},${pos.startY}`
        if (pos.hasOwnProperty("endX") || pos.hasOwnProperty("endY")) {
          id += `-${pos.endX ?? ""},${pos.endY ?? ""}`
        }
        return id
      }

      function getCellParent() {
        const main = document.querySelector("main")
        return main ?? document.body
      }

      function addCellToGrid(position, id, color) {
        // Create an element
        const element = document.createElement("figure")
        element.setAttribute("id", id)
        element.classList.add("cell")
        // Set the position to the avatar's
        positionOnGrid(element, position.startX, position.startY)
        setPositionAbsolute(element)
        element.style.setProperty("background-color", color)
        // Add to the landscape
        const parentElement = getCellParent()
        parentElement.appendChild(element)

        return element
      }

      function removeCellFromGrid(element) {
        const parentElement = getCellParent()
        parentElement.removeChild(element)
      }

      function onSpacePress(event) {
        if (event.key === " ") {
          const you = document.getElementById("you")
          if (!you) {
            return
          }

          const gridPosition = getPositionOnGrid(you)
          const landscapeId = createIdFromPosition(gridPosition)
          const alreadyExists = document.getElementById(landscapeId)
          if (alreadyExists) {
            // TODO: Check if cell exists in the newLandscapeMap
            // so you can only modify the cells you've added
            // Remove cell from the landscape
            removeCellFromGrid(alreadyExists)
          } else {
            // Add cell to the landscape
            addCellToGrid(gridPosition, landscapeId, state.newLandscapeColor)
            // Track what specific cells were added in this session
            state.newLandscapeMap[landscapeId] = { position: gridPosition, color: state.newLandscapeColor }
            // Persist the cells across page loads
            addToSavedLandscape(gridPosition, state.newLandscapeColor)
          }
        }
      }

      function getSavedLandscape() {
        const landscape = localStorage.getItem(LANDSCAPE_KEY)
        if (!landscape) {
          return {}
        }

        try {
          const landscapeData = JSON.parse(landscape)
          return landscapeData
        } catch (err) {
          console.error("landscape data is invalid, resetting", err)
          localStorage.removeItem(LANDSCAPE_KEY)
          return {}
        }
      }

      function addToSavedLandscape(position, color) {
        const landscape = getSavedLandscape()
        const id = createIdFromPosition(position)
        landscape[id] = { position, color }
        localStorage.setItem(LANDSCAPE_KEY, JSON.stringify(landscape))
      }

      // This is just to make color palette selection easier lol
      const colorsToList = new Set()
      function onClickRecordColor(event) {
        if (!event.target) {
          return
        }

        const color = event.target.style.getPropertyValue("background-color")
        if (color && color.length > 0) {
          if (colorsToList.has(color)) {
            colorsToList.delete(color)
            event.target.style.setProperty("border", "none")
          } else {
            colorsToList.add(color)
            event.target.style.setProperty("border", "1px dotted black")
          }
        }
      }

      // Just for my own visualization ty, ty
      function printWholeColorPalletes() {
        const colorStartPosition = { startX: 2, startY: 3 }
        const colorGridWidth = 15
        COLOR_NAMES.forEach((color, i) => {
          const startX = i % 15 + colorStartPosition.startX
          const startY = Math.floor(i / 15) + colorStartPosition.startY
          const colorCell = addCellToGrid({ startX, startY }, createIdFromPosition({ startX, startY }), color)
          colorCell.addEventListener("click", onClickRecordColor)
        })

        const chosenStartPosition = { startX: 2, startY: 15 }
        CHOSEN_PALETTE.forEach((color, i) => {
          const startX = i % 15 + chosenStartPosition.startX
          const startY = Math.floor(i / 15) + chosenStartPosition.startY
          addCellToGrid({ startX, startY }, createIdFromPosition({ startX, startY }), color)
        })
      }

      document.addEventListener("DOMContentLoaded", () => {
         // position elements on grid based on their pre-defined locations
        for (const selector of Object.keys(initialPositions)) {
          const positions = initialPositions[selector]
          positionOnGridBySelector(selector, positions)
        }

        // get the tagged obstacles and record their grid positions
        const obstacles = document.querySelectorAll('[data-obstacle]')
        obstacles.forEach((o) => {
          const { scrollX, scrollY } = window
          const { top, left, width, height } = o.getBoundingClientRect()
          const position = { startX: pixelsToGrid(scrollX + left), startY: pixelsToGrid(scrollY + top) }
          if (width > GRID_SIZE_PX) {
            const widthExceedingCell = width - GRID_SIZE_PX
            position.endX = pixelsToGrid(scrollX + left + widthExceedingCell)
          }

          if (height > GRID_SIZE_PX) {
            const heightExceedingCell = height - GRID_SIZE_PX
            position.endY = pixelsToGrid(scrollY + top + heightExceedingCell)
          }
          state.obstacles.push(position)
        })

        // Create any pre-defined active areas and add them
        // to the global state
        if (activeAreasToCreate && Array.isArray(activeAreasToCreate)) {
          activeAreasToCreate.forEach(area => {
            state.activeAreas.push(
              createActiveArea(area.point, area.activation, area.options)
            )
          })
        }

        // Set up the landscape
        state.newLandscapeColor = getRandomElement(CHOSEN_PALETTE)
        const landscape = getSavedLandscape()
        state.landscapeMap = landscape
        Object.keys(state.landscapeMap).forEach((id) => {
          addCellToGrid(state.landscapeMap[id].position, id, state.landscapeMap[id].color)
        })

        // Move the avatar based on arrow presses
        document.addEventListener("keydown", onKeyDown)
        // Add elements to the landscape based on avatar position
        document.addEventListener("keydown", onSpacePress)


        // Just for dev
        // printWholeColorPalletes()
      })
    </script>
  </head>
  <body>
    <nav>
      <a href="/">back</a>
    </nav>
    <main>
      <p id="direction" class="">You've crossed an ocean to be here.</p>
      <p class="info">
        This is a messy prototype of a game epilogue for <i>Meet me on the deep net</i>, <br/>
        where I'd like to offer you the chance to contribute to a landscape filled with <br/>
        impressions of the people, computers, browsers, that have made it here.
      </p>
      <p class="info">
        It's a work in progress! Try it out. You can move through the space using <br/>
        <code>WASD</code> or the arrow keys. Press <code>space</code> to place a color in the landscape. <br/>
        Press it again to remove it.
      </p>
      <figure id="you" class="cell center">you</figure>
    </main>
    <section role="toolbar" class="controls">
      <button class="toggle" onclick="printPositions()">print (dev)</button>
      <button class="toggle" onclick="toggleGrid()">toggle grid</button>
    </section>
    <!-- For easy dev -->
    <script src="./draggable.js" defer></script>
  </body>
</html>